#!/usr/bin/env bash
# Purpose: Private publish workflow for this repo. Run after you have committed
#          your changes and updated any docs that need manual edits. This script:
#          1) Bumps VERSION (from last commit message or --major/--minor/--patch)
#          2) Regenerates doc artifacts (SKILLS.md, facts, managed blocks)
#          3) Commits the bump and doc sync.
# Usage:   ./scripts/publish [--major|--minor|--patch] [--push]
#          With no bump flag, infers bump type from the last commit message.
# Created: 2026-02-19
# Last updated: 2026-02-19

set -euo pipefail

REPO_ROOT=""
if command -v git >/dev/null 2>&1; then
  REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null)" || true
fi
[[ -z "$REPO_ROOT" ]] || [[ ! -d "$REPO_ROOT" ]] && REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$REPO_ROOT"

BUMP_FLAG=""
DO_PUSH=false
while [[ $# -gt 0 ]]; do
  case "$1" in
    --major|--minor|--patch) BUMP_FLAG="$1"; shift ;;
    --push) DO_PUSH=true; shift ;;
    -h|--help)
      sed -n '2,10p' "$0" | sed 's/^# \?//'
      exit 0
      ;;
    *) shift ;;
  esac
done

BUMP_SCRIPT="$REPO_ROOT/scripts/bump-version"
if [[ ! -f "$BUMP_SCRIPT" ]]; then
  echo "Missing $BUMP_SCRIPT" >&2
  exit 1
fi
[[ -x "$BUMP_SCRIPT" ]] || chmod +x "$BUMP_SCRIPT" 2>/dev/null || true

# 1. Bump version
if [[ -n "$BUMP_FLAG" ]]; then
  NEW_VERSION="$("$BUMP_SCRIPT" "$BUMP_FLAG")"
else
  MSG_FILE="${TMPDIR:-/tmp}/localsetup_last_commit_msg.$$"
  git log -1 --format=%B > "$MSG_FILE" 2>/dev/null || true
  if [[ ! -s "$MSG_FILE" ]]; then
    NEW_VERSION="$("$BUMP_SCRIPT" --patch)"
  else
    NEW_VERSION="$("$BUMP_SCRIPT" "$MSG_FILE")"
  fi
  rm -f "$MSG_FILE"
fi

# 2. Regenerate doc artifacts
if [[ -f "$REPO_ROOT/scripts/generate-doc-artifacts" ]]; then
  [[ -x "$REPO_ROOT/scripts/generate-doc-artifacts" ]] || chmod +x "$REPO_ROOT/scripts/generate-doc-artifacts" 2>/dev/null || true
  "$REPO_ROOT/scripts/generate-doc-artifacts"
fi

# 3. Stage version and doc outputs only (no generic git add -A)
git add VERSION
git add README.md framework/README.md 2>/dev/null || true
git add framework/docs/*.md docs/*.md 2>/dev/null || true
git add framework/docs/_generated/facts.json 2>/dev/null || true

if git diff --staged --quiet; then
  echo "Nothing to commit (version $NEW_VERSION already in sync)."
  exit 0
fi

# 4. Commit
git commit -m "chore: bump to $NEW_VERSION and sync docs"

# 5. Optional push
if [[ "$DO_PUSH" == true ]]; then
  git push origin main
  echo "Published: $NEW_VERSION (pushed to origin main)"
else
  echo "Published: $NEW_VERSION (committed; run 'git push origin main' to push)"
fi
