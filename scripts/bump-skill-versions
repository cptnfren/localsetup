#!/usr/bin/env bash
# Localsetup v2  - Bump metadata.version in SKILL.md (Agent Skills spec).
# Purpose: Increment skill document version when a skill is updated; used by commit-msg hook.
# Usage:
#   bump-skill-versions [path/to/SKILL.md ...]   # bump listed files
#   bump-skill-versions --staged                 # bump all staged framework/skills/*/SKILL.md
# Exit: 0 if any file was bumped, 0 if none (no change), 1 on error.

set -euo pipefail

REPO_ROOT=""
if command -v git >/dev/null 2>&1; then
  REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null)" || true
fi
[[ -z "$REPO_ROOT" ]] || [[ ! -d "$REPO_ROOT" ]] && REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Increment last component of version string (1.0 -> 1.1, 1.0.0 -> 1.0.1)
bump_patch() {
  local v="$1"
  if [[ -z "$v" ]]; then
    echo "1.0"
    return
  fi
  local last="${v##*.}"
  local rest="${v%.*}"
  if [[ "$rest" == *.* ]]; then
    echo "${rest}.$((last + 1))"
  else
    echo "${rest}.$((last + 1))"
  fi
}

# Read current version from frontmatter (first --- block); look for "version:" with optional indent
get_version() {
  local file="$1"
  sed -n '/^---$/,/^---$/p' "$file" 2>/dev/null | grep -E '^\s*version:\s*' | head -1 | sed -E 's/.*version:\s*["'\'']?([0-9.]+)["'\'']?.*/\1/' || true
}

# Replace first occurrence of version: "X.Y" or version: "X.Y.Z" in frontmatter with new version
set_version() {
  local file="$1"
  local newver="$2"
  local tmp="${file}.bump$$"
  local in_fm=0
  local done=0
  while IFS= read -r line; do
    if [[ "$line" == "---" ]]; then
      in_fm=$((1 - in_fm))
      echo "$line"
      continue
    fi
    if [[ $in_fm -eq 1 ]] && [[ $done -eq 0 ]] && [[ "$line" =~ ^[[:space:]]*version:[[:space:]]* ]]; then
      echo "$line" | sed -E "s/^([[:space:]]*version:[[:space:]]*)[\"']?[0-9.]+[\"']?/\1\"$newver\"/"
      done=1
      continue
    fi
    echo "$line"
  done < "$file" > "$tmp"
  mv "$tmp" "$file"
}

# Add metadata.version if missing (after description, before ---)
add_version_if_missing() {
  local file="$1"
  if sed -n '/^---$/,/^---$/p' "$file" | grep -qE '^\s*version:\s*'; then
    return 0
  fi
  # Insert metadata block after description line
  local tmp="${file}.bump$$"
  local inserted=0
  while IFS= read -r line; do
    echo "$line"
    if [[ $inserted -eq 0 ]] && [[ "$line" =~ ^description: ]]; then
      echo "metadata:"
      echo "  version: \"1.0\""
      inserted=1
    fi
  done < "$file" > "$tmp"
  mv "$tmp" "$file"
}

bump_one() {
  local path="$1"
  [[ ! -f "$path" ]] && return 0
  local current
  current="$(get_version "$path")"
  if [[ -z "$current" ]]; then
    add_version_if_missing "$path"
    return 0
  fi
  local newver
  newver="$(bump_patch "$current")"
  set_version "$path" "$newver"
  echo "$path: $current -> $newver" >&2
}

# Sync version from framework/skills/X/SKILL.md to framework/.cursor/skills/X/SKILL.md
sync_cursor_copy() {
  local skill_path="$1"
  local newver="$2"
  if [[ "$skill_path" != *"/framework/skills/"* ]]; then
    return 0
  fi
  local name
  name="$(echo "$skill_path" | sed -n 's|.*/framework/skills/\([^/]*\)/SKILL\.md|\1|p')"
  [[ -z "$name" ]] && return 0
  local cursor_path="$REPO_ROOT/framework/.cursor/skills/$name/SKILL.md"
  if [[ -f "$cursor_path" ]]; then
    set_version "$cursor_path" "$newver"
    echo "$cursor_path: synced $newver" >&2
  fi
}

BUMPED=0
STAGED_ONLY=0
PATHS=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    --staged)
      STAGED_ONLY=1
      shift
      ;;
    -h|--help)
      sed -n '2,8p' "$0" | sed 's/^# \?//'
      exit 0
      ;;
    *)
      PATHS+=("$1")
      shift
      ;;
  esac
done

if [[ $STAGED_ONLY -eq 1 ]]; then
  while IFS= read -r p; do
    [[ -z "$p" ]] || PATHS+=("$REPO_ROOT/$p")
  done < <(git -C "$REPO_ROOT" diff --cached --name-only 2>/dev/null | grep -E '^framework/skills/[^/]+/SKILL\.md$' || true)
fi

for p in "${PATHS[@]}"; do
  [[ -f "$p" ]] || continue
  abs_path="$p"
  [[ "$p" != /* ]] && abs_path="$REPO_ROOT/$p"
  current="$(get_version "$p")"
  if [[ -z "$current" ]]; then
    add_version_if_missing "$p"
    sync_cursor_copy "$abs_path" "1.0"
    BUMPED=1
    echo "$p: added version 1.0" >&2
    continue
  fi
  newver="$(bump_patch "$current")"
  set_version "$p" "$newver"
  sync_cursor_copy "$abs_path" "$newver"
  BUMPED=1
  echo "$p: $current -> $newver" >&2
done

exit 0
