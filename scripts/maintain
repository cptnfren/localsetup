#!/usr/bin/env bash
# Localsetup v2  - Framework maintenance: bump version, commit, push to main
# Purpose: After modifications, bump patch version, commit all changes, push to origin main.
#          This keeps the framework on main current; it is not a formal "release" process.
# Usage:   ./scripts/maintain [commit-message]
#          If message omitted, uses: chore: maintain (bump to X.Y.Z)
# Created: 2026-02-18
# Last updated: 2026-02-18

set -euo pipefail

REPO_ROOT=""
if command -v git >/dev/null 2>&1; then
  REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null)" || true
fi
[[ -z "$REPO_ROOT" ]] || [[ ! -d "$REPO_ROOT" ]] && REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$REPO_ROOT"

# 1. Bump patch version (updates VERSION, READMEs, doc front matter)
"$REPO_ROOT/scripts/bump-version" --patch
NEW_VERSION="$(cat "$REPO_ROOT/VERSION")"

# 1.1 Generate docs artifacts from canonical sources
if [[ -f "$REPO_ROOT/scripts/generate-doc-artifacts" ]]; then
  "$REPO_ROOT/scripts/generate-doc-artifacts"
fi

# 2. Stage all changes
git add -A
if git diff --staged --quiet && git diff --quiet; then
  echo "Nothing to commit. Working tree clean."
  exit 0
fi

# 3. Commit
COMMIT_MSG="${1:-chore: maintain (bump to $NEW_VERSION)}"
git commit -m "$COMMIT_MSG"

# 4. Push to main (keeps framework current on main)
git push origin main

echo "Maintained: $NEW_VERSION (pushed to origin main)"
